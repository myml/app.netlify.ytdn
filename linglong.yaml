version: "1"

package:
  id: app.netlify.ytdn
  name: ytDownloader
  version: 3.20.2.0201
  kind: app
  description: |
    Download videos and audios from hundreds of sites
  author: wurongjie@deepin.org

base: org.deepin.base/25.2.1

command:
  - "/opt/apps/app.netlify.ytdn/files/opt/YTDownloader/ytdownloader"

build: |
  dpkg-deb -X linglong/sources/YTDownloader_Linux.deb $PREFIX/
  mkdir -p $PREFIX/share
  mv $PREFIX/usr/share/icons $PREFIX/usr/share/applications $PREFIX/share/
  rm -r $PREFIX/usr
  # 重命名图标文件，避免和其他应用冲突
  find $PREFIX/share/icons -type f -name "ytdownloader.png" | while read line; do
    newpath=$(echo $line | sed "s#ytdownloader#$LINGLONG_APPID#")
    mv $line $newpath
  done
  # 重命名.desktop文件，避免和其他应用冲突
  mv $PREFIX/share/applications/ytdownloader.desktop $PREFIX/share/applications/$LINGLONG_APPID.desktop
  # 修改.desktop文件内容
  sed -i "s#Icon=ytdownloader#Icon=$LINGLONG_APPID#g" $PREFIX/share/applications/$LINGLONG_APPID.desktop
  sed -i "s#/opt/YTDownloader/ytdownloader#$PREFIX/opt/YTDownloader/ytdownloader#g" $PREFIX/share/applications/$LINGLONG_APPID.desktop

  mkdir -p $PREFIX/bin/
  cp linglong/sources/yt-dlp $PREFIX/bin/

  mkdir -p $PREFIX/etc/
  cat profile.template | envsubst > $PREFIX/etc/profile
  cat ld.so.conf.template | envsubst > $PREFIX/etc/ld.so.conf

buildext:
  apt:
    depends:
      - ffmpeg
      # ffmpeg依赖这两个包的so，但没写到依赖里，需要手动添加
      - libblas3
      - liblapack3

sources:
  - kind: file
    url: https://edgeone.gh-proxy.com/https://github.com/aandrew-me/ytDownloader/releases/download/v3.20.2/YTDownloader_Linux.deb
    digest: 1a898b936a7036d08ba68dc461be8a2e66f8677951247a8aeecb8bffbb28553d
    name: YTDownloader_Linux.deb
  - kind: file
    url: https://edgeone.gh-proxy.com/https://github.com/yt-dlp/yt-dlp/releases/download/2026.01.31/yt-dlp_linux
    digest: 2fbc54f753ead15bb85af8c7fbd61480cd4263d17edd63b3a585bb75f8c237b1
    name: yt-dlp
